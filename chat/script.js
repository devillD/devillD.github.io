const socket=io("https://www.asown.workers.dev");let autoScrollEnabled=!0,isLoadingMoreMessages=!1,SECRET_KEY="xSAjwEE70Ilu4EN6iM1yTB-9A6ut4OfWDVmlZi82Q_w=";function setSecretKey(e){SECRET_KEY=e}function encryptMessage(e){let t=CryptoJS.lib.WordArray.random(16),s=CryptoJS.AES.encrypt(e,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:t});return t.toString()+":"+s.toString()}function decryptMessage(e){let t=e.split(":");if(2!==t.length)return console.error("Invalid ciphertext format"),null;let s=CryptoJS.enc.Hex.parse(t[0]),l=t[1],n=CryptoJS.AES.decrypt(l,CryptoJS.enc.Base64.parse(SECRET_KEY),{iv:s}),a=n.toString(CryptoJS.enc.Utf8);return a||console.warn("Decryption failed for message:",e),a}function validateInputs(){let e=document.getElementById("username").value,t=document.getElementById("roomId").value,s=/^[a-zA-Z0-9]{4,20}$/.test(e);document.getElementById("username").style.backgroundColor=s?"lightgreen":"lightcoral";let l=/^\d{1,5}$/.test(t);return document.getElementById("roomId").style.backgroundColor=l?"lightgreen":"lightcoral",s&&l}function scrollToBottom(){let e=document.getElementById("messages");e.scrollTop=e.scrollHeight}function createMessageElement(e,t,s,l,n){let a=document.createElement("div");if(a.className=s?"message user":"message receiver",n){let o=document.createElement("img");o.src=n,o.alt="User uploaded image",o.style.maxWidth="200px",a.appendChild(o)}else{let r=decryptMessage(t);a.innerText=r,r||(console.warn("Decryption failed for message:",t),a.innerText="[Message could not be decrypted]")}return a.dataset.timestamp=l,a}document.getElementById("join").addEventListener("click",()=>{if(validateInputs()){let e=document.getElementById("username").value,t=document.getElementById("roomId").value;socket.emit("joinRoom",{username:e,roomId:t}),document.getElementById("login-form").style.display="none",document.getElementById("chat-container").style.display="flex"}else alert("Login failed: Please enter valid username and room ID.")}),socket.on("previousMessages",e=>{console.log("Received previous messages:",e),e.forEach(({username:e,message:t,timestamp:s,imageUrl:l})=>{let n=document.getElementById("username").value,a=createMessageElement(e,t,e===n,s,l);document.getElementById("messages").appendChild(a)}),scrollToBottom()}),socket.on("olderMessages",e=>{let t=document.getElementById("messages"),s=t.scrollHeight;e.forEach(({username:e,message:s,timestamp:l,imageUrl:n})=>{let a=document.getElementById("username").value,o=createMessageElement(e,s,e===a,l,n);t.insertBefore(o,t.firstChild)}),t.scrollTop=t.scrollHeight-s,isLoadingMoreMessages=!1}),socket.on("chatMessage",({user:e,message:t,imageUrl:s})=>{let l=document.getElementById("username").value;if(s){let n=createMessageElement(e,null,e===l,null,s);document.getElementById("messages").appendChild(n)}else{let a=createMessageElement(e,t,e===l,null);document.getElementById("messages").appendChild(a)}autoScrollEnabled&&scrollToBottom()}),document.getElementById("imageUpload").addEventListener("change",function(){let e=document.getElementById("imageUploadLabel"),t=this.files[0];if(t){e.textContent=`ðŸ“· ${t.name}`;let s=new FileReader;s.onload=function(s){let l=s.target.result,n=document.getElementById("roomId").value;socket.emit("imageUpload",{roomId:n,file:{name:t.name,data:l}}),document.getElementById("imageUpload").value="",e.textContent="\uD83D\uDCF7"},s.readAsArrayBuffer(t)}else e.textContent="\uD83D\uDCF7"}),socket.on("imageUpload",({user:e,imageUrl:t})=>{let s=document.getElementById("username").value,l=createMessageElement(e,null,e===s,null,t);document.getElementById("messages").appendChild(l),autoScrollEnabled&&scrollToBottom()});let typingTimeout;function sendMessage(){let e=document.getElementById("message"),t=e.value,s=document.getElementById("roomId").value;if(t){let l=encryptMessage(t);socket.emit("chatMessage",{roomId:s,message:l}),e.value="",socket.emit("stopTyping",s)}}document.getElementById("message").addEventListener("input",()=>{let e=document.getElementById("roomId").value;e&&(socket.emit("typing",e),clearTimeout(typingTimeout),typingTimeout=setTimeout(()=>{socket.emit("stopTyping",e)},1e3))}),document.getElementById("send").addEventListener("click",sendMessage),document.getElementById("message").addEventListener("keydown",e=>{"Enter"===e.key&&(sendMessage(),e.preventDefault())}),socket.on("typing",e=>{let t=document.getElementById("messages"),s=t.querySelector(".typing-indicator"),l=document.getElementById("username").value;if(e!==l&&!s){let n=document.createElement("div");n.className="typing-indicator",n.innerText=`${e} is typing...`,t.appendChild(n)}}),socket.on("stopTyping",()=>{let e=document.querySelector(".typing-indicator");e&&e.remove()}),socket.on("updateActiveUsers",e=>{let t=document.getElementById("username").value,s=e.filter(e=>e.username!==t);document.getElementById("active-users").innerHTML="Active Users: "+s.map(e=>e.username).join(", ")}),document.getElementById("messages").addEventListener("scroll",()=>{let e=document.getElementById("messages");if(0===e.scrollTop&&!isLoadingMoreMessages){isLoadingMoreMessages=!0;let t=document.getElementById("roomId").value,s=e.firstChild?.dataset?.timestamp;t&&s&&socket.emit("loadMoreMessages",{roomId:t,oldestMessageTimestamp:s})}let l=e.scrollHeight-e.scrollTop<=e.clientHeight+5;autoScrollEnabled=l}),scrollToBottom();
